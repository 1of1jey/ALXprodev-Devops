#!/bin/bash

# Batch Pokémon Data Fetcher
# Fetches data for multiple Pokémon and saves to separate files
# Includes rate-limiting delay between requests

API_BASE_URL="https://pokeapi.co/api/v2/pokemon"
OUTPUT_DIR="pokemon_data"
ERROR_FILE="errors.txt"
DELAY=1  # Delay in seconds between requests

# List of Pokémon to fetch
POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")

# Create output directory if it doesn't exist
mkdir -p "$OUTPUT_DIR"

# Loop through each Pokémon
for pokemon in "${POKEMON_LIST[@]}"; do
    echo "Fetching data for $pokemon..."
    
    # Convert to lowercase for API request
    pokemon_lower=$(echo "$pokemon" | tr '[:upper:]' '[:lower:]')
    
    # Make API request and capture HTTP status code
    HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" "$API_BASE_URL/$pokemon_lower")
    
    # Extract HTTP status code (last line)
    HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -n 1)
    
    # Extract response body (everything except last line)
    RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | sed '$d')

     
    # Check if request was successful (HTTP 200)
    if [ "$HTTP_CODE" -eq 200 ]; then
        OUTPUT_FILE="$OUTPUT_DIR/${pokemon_lower}.json"
        echo "$RESPONSE_BODY" > "$OUTPUT_FILE"
        echo "Saved data to $OUTPUT_FILE"
    else
        # Log error with timestamp
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
        echo "[$TIMESTAMP] Error: HTTP $HTTP_CODE - Failed to fetch data for $pokemon_lower" >> "$ERROR_FILE"
        echo "Error: Request failed with HTTP code $HTTP_CODE for $pokemon_lower"
    fi
    
    # Add delay between requests to avoid rate-limiting
    # Skip delay after the last Pokémon
    if [ "$pokemon" != "${POKEMON_LIST[-1]}" ]; then
        sleep "$DELAY"
    fi
done
